---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(fable)
library(tsibble)
library(tsibbledata)
library(lubridate)
library(dplyr)
library(tidyverse)
library(neonstore)
library(distributional)
library(scoringRules)
```


#Downloading 30min_target file
```{r}
## guess_max must be large enough to avoid creating NAs, see the warning message from smaller guess_max
terrestrial_targets_30min <- 
  read_csv(paste0("https://data.ecoforecast.org/targets/terrestrial/",
                  "terrestrial_30min-targets.csv.gz"),
           guess_max = 20000)
```



Converting target files into tibble format

```{r}
## Check for duplicates first:  hmm... lots of duplicates
tsibble::duplicates(terrestrial_targets_30min, index=time, key=siteID)
## ick, let's just drop duplicates by requesting only distinct rows:
terrestrial_targets_30min <- distinct(terrestrial_targets_30min)

target30 <-as_tsibble(terrestrial_targets_30min, index = time, key = siteID)

## you haven't downloaded these... make sure script is reproducible!
swvc30<- as_tsibble(sm30_target,index = time, key = siteID)
```
Saving forecast for each target +Creating pivot table


```{r}
ARIMA_nee_saved <- 
  target30 %>%
  fill("nee") %>% 
  model(arima = ARIMA(nee) )%>% 
  forecast(h = "35 d") %>% 
  mutate(mean = mean(nee),
         sd = sqrt(variance(nee)))
```



```{r}
# FIXME this isn't following the standard.  names must be `statistic`
# Also, consider using `select` to get rid of columns you don't need first
# Also let's convert back to tibble so we don't get nee column carried over
ARIMA_nee_long <- ARIMA_nee_saved %>% 
  as_tibble() %>% 
  select(time, siteID, .model, mean, sd) %>%
  pivot_longer(c(`sd`, `mean`),
               names_to = "statistic", 
               values_to = "nee", 
               names_repair = "unique")


any(is.na(ARIMA_nee_long$nee))
```

```{r}
ARIMA_le_saved<-target30 %>% fill("le") %>% 
 model(arima = ARIMA(le)) %>% 
  forecast(h="1 year") %>% 
  mutate(mean_le=mean(le),
         sd_le=sqrt(variance(le)))
```

```{r}
ARIMA_le_saved <- ARIMA_le_saved %>% 
  pivot_longer(c(`mean_le`, `sd_le`),
               names_to = "statistics", 
               values_to = "le", 
               names_repair = "unique")
```


```{r}
ARIMA_swvc_saved<-swvc30 %>% fill("vswc", .direction = "up") %>% 
  model(arima= ARIMA(vswc)) %>% 
  forecast(h= "1 year") %>% 
  mutate(mean_vswc=mean(vswc),
         sd_vswc=sqrt(variance(vswc))) %>%
  rename(mean = mean_vswc, sd = sd_vswc)
```

```{r}
ARIMA_swvc_saved <- AR

```{r}
target30 %>% 
  model(
    
    arima = ARIMA(le)
    
  ) %>% forecast(h = "1 year") %>% 
  autoplot(target30)
```
#checking le forecast accuracy
```{r}
forecastle <-target30 %>% 
  fill(c("nee", "le")) %>% 
  model(
    ets=ETS(le),
    arima = ARIMA(le),
    snaive=SNAIVE(le)
  )
```
#Compare the accuracy of the different models for each site (AICs values)
```{r}
forecastle
glance(forecastle) %>% arrange(AICc)
```
# getting report on ARIMA model "le" for BART site
```{r}
fitbartLE<-target30 %>% fill(("le")) %>% 
  filter(siteID =="BART") %>% 
  model(arima = ARIMA(nee))
```
```{r}
report(fitbartLE)
```

#getting report on ARIMA model "nee" for BART site
```{r}
fitbart<-target30 %>% fill(("nee")) %>% 
  filter(siteID =="BART") %>% 
  model(arima = ARIMA(nee))
```

```{r}
report(fitbart)
#Here ARIMA selected a seasonal ARIMA model to perform our forecast .
```
#getting report on ARIMA model "nee" for SRER site
```{r}
fitsrer<-target30 %>% fill(("nee")) %>% 
  filter(siteID =="SRER") %>% 
  model(arima = ARIMA(nee))
```
```{r}
report(fitsrer)
```
```{r}
accuracy(fitsrer)
```


#Joining forecast tables together into one table
```{r}
forecast_saved <- cbind(ARIMA_nee_saved, ARIMA_le_saved$mean_le, ARIMA_le_saved$sd_le,ARIMA_swvc_saved$Mean,ARIMA_swvc_saved$St) %>% 
 rename(
   mean_le = `ARIMA_le_saved$mean_le`,
   var_le = `ARIMA_le_saved$var_le`,
   mean_vswc = `ARIMA_swvc_saved$mean_vswc`,
   var_vswc = `ARIMA_swvc_saved$var_vswc`) %>%  
  mutate(sd_nee= sqrt(var_nee),
         sd_le= sqrt(var_le),
         sd_vswc=sqrt(var_vswc),
         data_assimilation = 0,
           forecast = 1) %>% 
  select(time, siteID, mean_nee, sd_nee, mean_le, sd_le, mean_vswc, sd_vswc, data_assimilation, forecast)
```


#Pivot Table Attempt #1
```{r}
forecast_saved<-forecast_saved %>% 
  pivot_longer(c(`mean_nee`, `sd_nee`), names_to = "nee_statistics", values_to = "nee") %>% pivot_longer(c(`mean_le`, `sd_le`), names_to = "le_statistics", values_to = "le") %>% pivot_longer(c(`mean_vswc`, `sd_vswc`), names_to = "vswc_statistics", values_to = "vswc") %>% distinct()
```

#Pivot Table Attempt #2
```{r}
forecast_saved<-forecast_saved %>% 
  pivot_longer(c(`mean_nee`, `sd_nee`, `mean_le`, `sd_le`, `mean_vswc`, `sd_vswc`), names_to = "statistics", values_to = c("value")) 
```



#Creating csv file for the forecasted values
```{r}
forecast_file_name_base <- paste0("terrestrial-",as_date(start_forecast),"-","UCB_XT")
forecast_file <- paste0(forecast_file_name_base, ".csv.gz")
write_csv(forecasts_saved, forecast_file)
```


#Joining forecast tables together into one table (not sure about this one)
```{r}
forecast_saved <- cbind(ARIMA_nee_saved, ARIMA_le_saved$.mean, ARIMA_swvc_saved$.mean) %>% 
 rename(NEE=.mean,
   LE = `ARIMA_le_saved$.mean`,
         VSWC = `ARIMA_swvc_saved$.mean`) %>% 
  select(time, siteID, NEE, LE, VSWC)
```

#Creating csv file for the forecasted values
```{r}
forecast_file_name_base <- paste0("terrestrial-",as_date(start_forecast),"-","UCB_XT")
forecast_file <- paste0(forecast_file_name_base, ".csv.gz")
write_csv(forecasts_saved, forecast_file)
```

```{r}
ggplot(forecast_saved, aes(x = time, y = NEE )) + 
  geom_line() +
  facet_wrap(~siteID)
```

#Joining forecast tables together into one table 
```{r}
forecast_saved2 <- cbind(ARIMA_nee_saved, ARIMA_le_saved$le, ARIMA_swvc_saved$vswc) %>% 
 rename(
   le = `ARIMA_le_saved$le`,
         vswc = `ARIMA_swvc_saved$vswc`) %>% 
  select(time, siteID, nee, le, vswc)
```

```{r}
forecast_file_name_base <- paste0("terrestrial-",as_date(start_forecast),"-","UCB_XT")
forecast_file <- paste0(forecast_file_name_base, ".csv.gz")
write_csv(forecast_saved2, forecast_file)
```

ARIMA_le_saved <- 
forecast_saved <- cbind(forecast_saved_nee, forecast_saved_le$le, forecast_saved_soil_moisture$vswc) %>% 
  rename(le = `forecast_saved_le$le`,
         vswc = `forecast_saved_soil_moisture$vswc`) %>% 
  select(time, ensemble, siteID, obs_flag, nee, le, vswc, forecast, data_assimilation)


